Equation3d = class('Equation3d')
Equation3d.tempV31 = Laya.Vector3(0, 0, 0);
Equation3d.tempV32 = Laya.Vector3(0, 0, 0);
Equation3d.tempV33 = Laya.Vector3(0, 0, 0);
function Equation3d.intersectsRayAndPlaneRP(ray, plane, out)
  local distance = {x=0}
  if not Equation3d.intersectsRayAndPlaneRD(ray, plane, distance) then
    out.x = 0
    out.y = 0
    out.z = 0
    return false
  end
  Laya.Vector3:scale(ray.direction, distance.x, Equation3d.tempV31)
  Laya.Vector3:add(ray.origin, Equation3d.tempV31, Equation3d.tempV32)
  out.x = Equation3d.tempV32.x
  out.y = Equation3d.tempV32.y
  out.z = Equation3d.tempV32.z
  return true
end

function Equation3d.intersectsRayAndPlaneRD(ray, plane, out)
  local planeNor = plane.normal
  local direction = Laya.Vector3:dot(planeNor, ray.direction)
  if Laya.MathUtils3D:isZero(direction) then
    out.x = 0
    return false
  end
  local position = Laya.Vector3:dot(planeNor, ray.origin)
  out.x = -plane.distance - position / direction
  if out.x < 0 then
    out.x = 0
    return false
  end
  return true
end

Equation3d._tempRay = Laya.Ray(Laya.Vector3(0, 0, 0), Laya.Vector3(0, 0, 0));
Equation3d._tempPointV3 = Laya.Vector3(0, 0, 0);
Equation3d._tempPointV3_2 = Laya.Vector3(0, 0, 0);
Equation3d._tempPointV2 = Laya.Vector2(0, 0);
Equation3d.defaultPlane_xy_z0 = Laya.Plane:createPlaneBy3P(Laya.Vector3(0, 0, 0), Laya.Vector3(1, 1, 0), Laya.Vector3(1, 2, 0));
function Equation3d.turnV2ToV3(stagex, stagey, camera, out, plane)
  if out == nil then
    out=nil
  end
  if plane == nil then
    plane=nil
  end
  Equation3d._tempPointV2.x = stagex
  Equation3d._tempPointV2.y = stagey
  camera:viewportPointToRay(Equation3d._tempPointV2, Equation3d._tempRay)
  if not plane then
    plane = Equation3d.defaultPlane_xy_z0
  end
  if not out then
    out = Laya.Vector3(0, 0, 0)
  end
  local rt = Equation3d.intersectsRayAndPlaneRP(Equation3d._tempRay, plane, out)
  return out
end

function Equation3d.turnV3ToV2(x, y, z, camera, out)
  local tempPoint = Equation3d._tempPointV3
  if not out then
    out = Laya.Vector3(0, 0, 0)
  end
  tempPoint.x = x
  tempPoint.y = y
  tempPoint.z = z
  camera.viewport:project(tempPoint, camera.projectionViewMatrix, out)
end
