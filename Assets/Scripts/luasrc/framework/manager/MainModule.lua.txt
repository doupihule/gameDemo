MainModule = class('MainModule')

MainModule.task_sceneComplete = "task_sceneComplete";
MainModule.task_updateListerner = "task_updateListerner";
MainModule.task_subpackage = "task_subpackage";
MainModule.task_configsloaded = "task_configsloaded";
MainModule.task_onloginResult = "task_onloginResult";
MainModule.task_mergeFileBack = "task_mergeFileBack";
MainModule.task_kariquLogin = "task_kariquLogin";

function MainModule.getInstance()
    return MainModule._instance
end

function MainModule:ctor()
    self.timeLock = 0;
    self._taskCompMap = {};
    MainModule._instance = self;
    self:initLayer()
    self:onLoadingUIComplete()
    Message.getInstance():add(MsgCMD.GAME_ONSHOW, self)
    Message.getInstance():add(MsgCMD.VIDEO_STOP, self)
    Message.getInstance():add(MsgCMD.VIDEO_PLAY, self)
end

function MainModule:onLoadingUIComplete()
    self.timeLock = Client.getInstance():getMiniServerTime()
    self:reqVMS()
end

function MainModule:reqVMS()
    UserInfo.platform:reqVMS()
end

function MainModule:checkSystem()
    local versionName = UserInfo.platform:getVersionName()
    VersionManager.getInstance().versionName = versionName
    LogsManager.echo("xd cdnurl:", Global.resource_url)
    LogsManager.echo("yrc req versionName:", versionName)
    VersionManager.getInstance():initVersionData()
    self:onVersionLoaded()
end


function MainModule:onVersionLoaded()
    VersionManager.getInstance():versionFileCheck()
    FuncManager.init(function(self)
        if Global.checkUserCloudStorage() then
            self:onLoginResult(Client.getInstance().globalLoginBackData)
            UserInfo.platform:getLoginResult()
        end
        self:sysCallback()
    end
    , self)
end

function MainModule:onConfigLoaded()
    self:changeShowMainTask(-1, MainModule.task_configsloaded, "onConfigLoaded")
end

function MainModule:sysCallback()
    LogsManager.echo(" ======--VMSTIME--======== " .. Client.getInstance():getMiniServerTime() - self.timeLock)
    if not Global.checkUserCloudStorage() then
        UserInfo.platform:getWxInfo()
    end
    self:loadMergeFiles()
    UserInfo.platform:initPlatformData()
end

function MainModule:changeByte(name)
end

function MainModule:loadMergeFiles()
    self:onMergeFileBack()
end

function MainModule:onMergeFileBack()
    self:changeShowMainTask(-1, MainModule.task_mergeFileBack, "onMergeFileBack")
end

function MainModule:loginResult()
    LogsManager.echo(" ======--GlobalTIME--======== " .. Client.getInstance():getMiniServerTime() - self.timeLock)
    if Global.isNotGuide() then

    end
    Client.getInstance():send(Method.User_login, {}, self.onLoginResult, self)
end

function MainModule:onLoginResult(result)
    LogsManager.echo("yrc onLoginResult", result)
    local serverData = result
    if not Global.checkUserCloudStorage() then
        Client.getInstance().globalLoginBackData = result
        serverData = result.data
    else
        UserInfo.platform:compareData(result)
    end
    if serverData.config then
        Client.getInstance().heartBeatInterval = result.data.config.heartBeatInterval
        if result.data.config.switch then
            GameSwitch.coverServerSwitchMap(result.data.config.switch)
            LogsManager.echo("yrc gameswitch resultSwitch", result.data.config.switch)
        end
        KakuraClient.getInstance():registHeartBeat()
    end
    LogsManager.echo("yrc SWITCH_LOG_PANEL:", GameSwitch.checkOnOff(GameSwitch.SWITCH_LOG_PANEL))
    LogsManager.setLogGroupVisible(GameSwitch.checkOnOff(GameSwitch.SWITCH_LOG_PANEL))
    local userData = serverData.user
    ModelToServerMapCommon.initModelToServerMap()
    local modelMap = ModelToServerMapCommon.modelToServerMap
    local length = #modelMap
    local i = 0
    for i, info in ipairs(modelMap) do
        local key = info.key
        local model = info.model
        if info.key == "user" then
            model.getInstance():initData(userData)
        else
            -- [ts2lua]userData下标访问可能不正确
            if not userData[key] then
                -- [ts2lua]userData下标访问可能不正确
                userData[key] = {}
            end
            -- [ts2lua]userData下标访问可能不正确
            local data = userData[key]
            model.getInstance():initData(data)
        end
    end
    UserGlobalModel.getInstance():flushGlobalData(self.getCloudGlobalDataResult, self)
    SoundManager.init()
    SoundManager.initSwitch()
end

function MainModule:getCloudGlobalDataResult(params)
    UserModel.getInstance():login()
    BannerAdManager.setBannerSwitch()
    self:changeShowMainTask(-1, MainModule.task_onloginResult, "onLoginResult")
end

MainModule.showMainTask = 6;
function MainModule:changeShowMainTask(value, key, tag)
    if tag == nil then
        tag = nil
    end
    MainModule.showMainTask = MainModule.showMainTask + value
    LogsManager.echo("yrc showMainTask", value, MainModule.showMainTask, "tag:", tag)
    -- [ts2lua]self._taskCompMap下标访问可能不正确
    self._taskCompMap[key] = true
    if MainModule.showMainTask == 0 then
        self:showGameMain()
    elseif MainModule.showMainTask < 0 then
        LogsManager.errorTag("mainTaskError", "taskError", MainModule.showMainTask, tag)
    end
end

function MainModule:checkHasTaskComplete(taskKey)
    -- [ts2lua]self._taskCompMap下标访问可能不正确
    return self._taskCompMap[taskKey]
end

function MainModule:showGameMain()
    Message.getInstance():send(FrameWorkEvent.FRAMEWORKEVENT_STARTENTERMAIN)
end

function MainModule:reStartGame()
end
function MainModule:initLayer()
    WindowManager.rootLayer = GlobalEnv.uiRoot
    WindowManager.commonUILayer = UITools.createUICtn()
    WindowManager.commonUILayer:setViewSize(ScreenAdapterTools.width, ScreenAdapterTools.height)
    WindowManager.rootLayer:addChild(WindowManager.commonUILayer)
    WindowManager.topUILayer = UITools.createUICtn()
    WindowManager.topUILayer:setViewSize(ScreenAdapterTools.width, ScreenAdapterTools.height)
    WindowManager.topUILayer.mouseEnabled = true
    WindowManager.topUILayer.mouseThrough = true
    WindowManager.rootLayer:addChild(WindowManager.topUILayer)
    WindowManager.guideLayer = UITools.createUICtn()
    WindowManager.guideLayer:setViewSize(ScreenAdapterTools.width, ScreenAdapterTools.height)
    WindowManager.guideLayer.cacheAs = "bitmap"
    WindowManager.rootLayer:addChild(WindowManager.guideLayer)
    WindowManager.guideLayer.mouseEnabled = true
    WindowManager.guideLayer.mouseThrough = true
    WindowManager.guideLayer:setViewActive(false)
    WindowManager.highLayer = UITools.createUICtn()
    WindowManager.highLayer:setViewSize(ScreenAdapterTools.width, ScreenAdapterTools.height)
    WindowManager.rootLayer:addChild(WindowManager.highLayer)
    WindowManager.toolsLayer = UITools.createUICtn()
    WindowManager.rootLayer:addChild(WindowManager.toolsLayer)
    WindowManager.maskLayer = UITools.createUICtn()
    WindowManager.maskLayer:setViewSize(ScreenAdapterTools.width, ScreenAdapterTools.height)
    WindowManager.rootLayer:addChild(WindowManager.maskLayer)
    WindowManager.tipsLayer = UITools.createUICtn()
    WindowManager.tipsLayer:setViewSize(ScreenAdapterTools.width, ScreenAdapterTools.height)
    WindowManager.tipsLayer.mouseEnabled = false
    WindowManager.tipsLayer.mouseThrough = true
    WindowManager.rootLayer:addChild(WindowManager.tipsLayer)
    WindowManager.debugLayer = UITools.createUICtn()
    WindowManager.rootLayer:addChild(WindowManager.debugLayer)
    LogsManager.initLogPanel()
    if UserInfo.isWeb() then
        local urlParam = string.find(window.location.href, 'test=1') ~= nil
        LogsManager.echo(">>>>urlParam>>>>>>", urlParam)
        GameSwitch.getSwitchMap().SWITCH_GM_DEBUG = 1
        GameSwitch.getSwitchMap().SWITCH_CD_DEBUG = 1
    end
    local delayShowLoading = function()
        WindowManager.ShowLoadingUI(nil)
    end

    if UserInfo.isWeb() then
        WindowManager.ShowLoadingUI(nil)
    else
        TimerManager.getInstance():add(delayShowLoading, nil, 10, 1)
    end
    if UserInfo.isSystemNative() then
        ScreenAdapterTools.checkFillBorder()
    end
end

function MainModule:onTTShow()
    LogsManager.echo("yrc onTTShow")
    if not UserInfo.platform.isPlayVideo then
        if WindowManager.isUIOpened(WindowCfgs.GameMainUI) then
            LogsManager.echo("yrc have GameMainUI")
            SoundManager.stopMusic()
            SoundManager.playBGM(MusicConst.MUSIC_BGM)
        else
            LogsManager.echo("yrc have not GameMainUI")
            SoundManager.playBGM()
        end
    end
end

function MainModule:gameClose()
end

function MainModule:playBGM()
    SoundManager.playBGM(MusicConst.MUSIC_BGM)
end

function MainModule:stopBGM()
    SoundManager.stopMusic()
end

function MainModule:recvMsg(cmd, data)
end
