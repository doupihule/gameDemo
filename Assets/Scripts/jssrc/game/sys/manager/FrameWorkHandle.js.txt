"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const UserModel_1 = require("../model/UserModel");
const UserInfo_1 = require("../../../framework/common/UserInfo");
const StatisticsManager_1 = require("./StatisticsManager");
const StatisticsCommonConst_1 = require("../../../framework/consts/StatisticsCommonConst");
const UserGlobalModel_1 = require("../../../framework/model/UserGlobalModel");
const GlobalParamsFunc_1 = require("../func/GlobalParamsFunc");
const WindowManager_1 = require("../../../framework/manager/WindowManager");
const WindowCfgs_1 = require("../consts/WindowCfgs");
const Message_1 = require("../../../framework/common/Message");
const FrameWorkEvent_1 = require("../../../framework/event/FrameWorkEvent");
const TranslateFunc_1 = require("../../../framework/func/TranslateFunc");
const LogsManager_1 = require("../../../framework/manager/LogsManager");
//主要用来处理框架相关不同的逻辑每个游戏独立维护,比如分享不一样的地方.  进入主界面不一样的地方
class FrameWorkHandle {
    //初始化函数. 需要侦听事件.每个游戏单独处理
    constructor() {
        //监听进入主界面消息
        Message_1.default.instance.add(FrameWorkEvent_1.default.FRAMEWORKEVENT_STARTENTERMAIN, this);
    }
    static get instance() {
        if (!this._instance) {
            this._instance = new FrameWorkHandle();
        }
        return this._instance;
    }
    static init() {
        if (!this._instance) {
            this._instance = new FrameWorkHandle();
        }
    }
    //针对游戏单独处理
    onStartEnterGameMain() {
        // var guideStep = UserModel.instance.getMainGuide();
        // if (guideStep == 0) {
        //     BattleSceneManager.instance.enterBattle({ roleId: UserModel.instance.getRole(), levelId: 1 });
        //     return;
        // }
        WindowManager_1.default.SwitchUIFromLoading(WindowCfgs_1.WindowCfgs.GameMainUI, WindowCfgs_1.WindowCfgs.LoginUI);
        if (UserInfo_1.default.platform.shareLinkParams && UserInfo_1.default.platform.shareLinkParams.contentId) {
            StatisticsManager_1.default.ins.onEvent(StatisticsCommonConst_1.default.SHARE_CLICK_ENTER, { contentId: UserInfo_1.default.platform.shareLinkParams.contentId });
        }
        if (UserInfo_1.default.platform.shareLinkParams && UserInfo_1.default.platform.shareLinkParams.inviterRid) {
            if (UserInfo_1.default.platform.shareLinkParams.inviterRid != UserModel_1.default.instance.getUserRid()) {
                // 新老用户均设置数据
                UserGlobalModel_1.default.setInviteUser(UserInfo_1.default.platform.shareLinkParams.inviterRid);
                var shareAddNum = GlobalParamsFunc_1.default.instance.getDataNum("shareTruePlayerNmb");
                UserGlobalModel_1.default.setOtherShareNum(UserInfo_1.default.platform.shareLinkParams.inviterRid, shareAddNum);
            }
        }
    }
    //当判断是否分享成功. 不同项目自己扩展重写
    onCheckShareSucess(distime, shareExtraData) {
        var shareResult = distime >= 3000;
        var platformObj = UserInfo_1.default.platform;
        if (shareResult) {
            platformObj.onShareComplete(shareResult);
        }
        else {
            //根据不同游戏自己做判断
            var failHandleType = GlobalParamsFunc_1.default.instance.shareHandleType;
            if (failHandleType == 1) {
                WindowManager_1.default.ShowTip("分享失败，请稍后再试");
                platformObj.onShareComplete(shareResult);
            }
            else if (failHandleType == 2) {
                UserInfo_1.default.platform.showPopTip("提示", TranslateFunc_1.default.shareTranslateArr[Math.floor(Math.random() * TranslateFunc_1.default.shareTranslateArr.length)], {
                    confirmText: TranslateFunc_1.default.shareLabTranslate,
                    success(res) {
                        if (res.confirm) {
                            LogsManager_1.default.echo('用户点击确定,再次拉起分享');
                            //再次拉起分享
                            platformObj.share(platformObj._shareId, platformObj._shareExtraData, platformObj.shareCallback, platformObj);
                        }
                        else if (res.cancel) {
                            LogsManager_1.default.echo("用户取消了再次分享");
                            platformObj.onShareComplete(false);
                        }
                    }
                });
            }
        }
    }
    //接受消息
    recvMsg(cmd, data) {
        if (cmd == FrameWorkEvent_1.default.FRAMEWORKEVENT_STARTENTERMAIN) {
            this.onStartEnterGameMain();
        }
    }
}
exports.default = FrameWorkHandle;
//# sourceMappingURL=FrameWorkHandle.js.map